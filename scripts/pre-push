#!/bin/bash
# Pre-push hook for Pencraft
# Runs all CI checks locally before pushing to catch issues early

set -e

echo "üîç Running pre-push checks..."
echo "================================"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Track failures
FAILED=0

# 1. Ruff linting
echo -e "\n${YELLOW}[1/4] Running ruff check...${NC}"
if python -m ruff check src/ tests/ 2>&1; then
    echo -e "${GREEN}‚úì Ruff check passed${NC}"
else
    echo -e "${RED}‚úó Ruff check failed${NC}"
    FAILED=1
fi

# 2. Ruff formatting
echo -e "\n${YELLOW}[2/4] Checking ruff format...${NC}"
if python -m ruff format src/ tests/ --check 2>&1; then
    echo -e "${GREEN}‚úì Ruff format passed${NC}"
else
    echo -e "${RED}‚úó Ruff format failed - run 'ruff format src/ tests/' to fix${NC}"
    FAILED=1
fi

# 3. Mypy type checking
echo -e "\n${YELLOW}[3/4] Running mypy...${NC}"
if python -m mypy src/ --ignore-missing-imports 2>&1; then
    echo -e "${GREEN}‚úì Mypy passed${NC}"
else
    echo -e "${RED}‚úó Mypy failed${NC}"
    FAILED=1
fi

# 4. Pytest
echo -e "\n${YELLOW}[4/4] Running tests...${NC}"
if python -m pytest tests/ -v --tb=short 2>&1; then
    echo -e "${GREEN}‚úì Tests passed${NC}"
else
    echo -e "${RED}‚úó Tests failed${NC}"
    FAILED=1
fi

echo ""
echo "================================"

if [ $FAILED -eq 1 ]; then
    echo -e "${RED}‚ùå Pre-push checks failed! Push aborted.${NC}"
    echo -e "${YELLOW}Fix the issues above and try again.${NC}"
    exit 1
else
    echo -e "${GREEN}‚úÖ All pre-push checks passed!${NC}"
    exit 0
fi
